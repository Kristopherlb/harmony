apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingAdmissionPolicy
metadata:
  name: dagger-ephemeral-volumes
spec:
  matchConstraints:
    resourceRules:
      - apiGroups: [""]
        apiVersions: ["v1"]
        operations: ["CREATE", "UPDATE"]
        resources: ["pods"]
  validations:
    - expression: |
        object.metadata.labels['app.kubernetes.io/part-of'] == 'dagger-runtime'
        ? !has(object.spec.volumes)
          || object.spec.volumes.all(v, !has(v.persistentVolumeClaim) && !has(v.hostPath))
        : true
      message: "Dagger runtime pods must not use persistentVolumeClaim or hostPath volumes."
---
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingAdmissionPolicyBinding
metadata:
  name: dagger-ephemeral-volumes-binding
spec:
  policyName: dagger-ephemeral-volumes
  matchResources:
    namespaceSelector:
      matchLabels:
        golden.dev/dagger-runtime: "true"
