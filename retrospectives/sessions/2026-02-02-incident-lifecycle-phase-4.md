## Retrospective: Incident Lifecycle Phase 4 (Blueprint Suite)

**Date:** 2026-02-02  
**Session Duration:** ~120 minutes  
**Artifacts Produced:**
- `plans/incident-lifecycle/usecase_brief.json`
- `plans/incident-lifecycle/acceptance_tests.json`
- `plans/incident-lifecycle/capability_gap_analysis.json`
- `plans/incident-lifecycle/architectures/*.architecture.json`
- Blueprints + tests:
  - `packages/blueprints/src/workflows/incident/*`
  - `packages/blueprints/src/descriptors/incident-*.descriptor.ts`
- Confluence templates:
  - `docs/incidents/templates/confluence/*.storage.html`

---

## What Went Well

### 1. TDD-friendly blueprint structure
Using a “pure orchestration logic module” plus a small `BaseBlueprint` wrapper kept orchestration deterministic, testable, and easy to reason about. We consistently wrote failing tests first for each workflow’s orchestration behavior.

### 2. Deterministic artifacts and discoverability hygiene (eventually)
Once the missing registry entries were resolved, regenerating the tool catalog and re-running sync produced deterministic registry outputs that match the repo’s discovery model.

### 3. Phase artifacts stayed aligned to existing patterns
URP artifacts under `plans/*/` and checkpoint retros followed existing repo conventions, minimizing churn and making Phase 4 traceable from inputs → architecture → code.

---

## What Could Have Been Better

### 1. Deterministic catalog / sync coupling surfaced late
`@golden/path:sync` failed because `tool-catalog.json` could not include IDs until registries were updated, but registries are typically generated by sync.

**Impact:** Extra iteration to reconcile capability/blueprint registries and rerun catalog generation before sync could succeed.

### 2. Approval role-gating limitations (Slack)
Slack interactive approvals currently arrive with `approverRoles: []`, so setting `requiredRoles` for Slack-driven approval can cause approvals to be ignored.

**Impact:** Easy to misconfigure approvals without realizing why the workflow keeps waiting.

### 3. Post-mortem fidelity blocked by missing timeline capability
Post-mortem content is currently a template scaffold with TODO sections because there’s no canonical, reusable timeline event capability feeding it.

**Impact:** Post-mortem automation produces structure but not high-quality populated content.

---

## The Golden Path (If It Existed)

```
┌─────────────────────────────────────────────────────────────────────┐
│  Step 1: Run URP scaffold generator                                  │
│  Outputs: plans/<usecase>/{brief,tests,gap}.json                      │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│  Step 2: Generate architecture plans (AST)                            │
│  Outputs: plans/<usecase>/architectures/*.json                        │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│  Step 3: Scaffold blueprints + descriptors + tests                    │
│  Outputs: workflows/* + descriptors/* + registry updates              │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│  Step 4: Regenerate tool catalog + run sync (one command)             │
│  Outputs: tool-catalog.json + deterministic registries                │
└─────────────────────────────────────────────────────────────────────┘
```

**Estimated time with golden path:** ~60 minutes (vs ~120 minutes actual)

---

## Recommendations

### Immediate (This Sprint)

| Action | Effort | Impact |
|--------|--------|--------|
| Ensure capability and blueprint registries include all concrete implementations before running sync | ~15m | Prevent sync/tool-catalog dead-ends |
| Document Slack approval role-gating limitation in incident workflow skill | ~10m | Reduce approval confusion |

### Near-Term (Next 2 Sprints)

| Action | Effort | Impact |
|--------|--------|--------|
| Extend blueprint generator to support deterministic constant/literal `input_mapping` values | ~1–2h | Smaller workflow input schemas + cleaner architecture plans |
| Add a timeline/audit capability to record incident events (`golden.transformers.incident-timeline`) | ~0.5–1d | Enables populated post-mortems and UI timeline views |

### Strategic (Roadmap)

| Action | Effort | Impact |
|--------|--------|--------|
| Implement Slack approval role claim mapping (populate `approverRoles`) | ~1–2d | Safe RBAC + Slack-driven approvals |

---

## Metrics

| Metric | Value | Target | Notes |
|--------|-------|--------|-------|
| Tool calls | ~100 | <120 | Includes test runs + catalog/sync recovery |
| Clarifying questions | 0 | 0–2 | Assumptions documented instead |
| Artifacts produced | 25+ | 20+ | URP + architectures + workflows + descriptors + templates |
| User round-trips | 2 | <5 | Short feedback cycles |

---

## Key Takeaway

> **The “logic module + workflow wrapper” pattern makes deterministic blueprint work fast and testable; discovery drift must be eliminated by making catalog + sync run reliably in one step.**

---

## Plan Alignment (Mandatory)

- Plan drift observed: minor (the sync/tool-catalog step required additional registry reconciliation; sequence was effectively “fix registries → generate tool catalog → run sync”).
- Plan update(s) to apply next time (copy/paste-ready):
  - Add a preflight step before Phase 4 coding: run `pnpm -w nx run mcp-server:generate-tool-catalog` and verify it contains all expected IDs for any newly-added capabilities/blueprints.
  - After each blueprint implementation, run `pnpm -w nx g @golden/path:sync` to surface discovery drift immediately.
  - Add a note: Slack approvals do not yet populate roles; do not set `requiredRoles` unless approvals are console/API-driven.
- New preflight steps to add:
  - A CI check that `packages/capabilities/index.ts` exports match `packages/capabilities/src/registry.ts` contents (prevent “implemented but undiscoverable” drift).

---

## Improvements / Capabilities That Would Help Next

| Type | Proposal | Effort | Expected Impact |
|------|----------|--------|-----------------|
| Capability/Generator | Add deterministic constant/literal mappings to blueprint generator | ~1–2h | Cleaner architecture plans + smaller input schemas |
| Capability | `golden.transformers.incident-timeline` (record + query incident events) | ~0.5–1d | Enables populated post-mortems + timeline UI |
| Tooling | One-command “regen + sync” wrapper that always produces deterministic outputs | ~30m | Removes repetitive manual steps |

